# Лабораторная работа №3 по Архитектуре Компьютера
- Сиразетдинов Азат Ниязович, P3216
- ```asm | stack | neum | hw | tick -> instr | struct | trap -> stream | mem | cstr | prob1 | spi```
- Упрощенный вариант

## Язык программирования
### Синтаксис
``` ebnf
program ::= { line }

line ::= label [ comment ] "\n"
       | instr [ comment ] "\n"
       | [ comment ] "\n"

label ::= label_name ":"

instr ::= op0 
        | op1 variable
        | op2 label_name
        | "WORD" word_data

op0 ::= "DUP" 
      | "OVER"
      | "POP"
      | "SWAP"
      | "LOAD"
      | "SAVE"
      | "INC"
      | "DEC"
      | "ADD"
      | "SUB"
      | "DIV"
      | "MUL"

op1 ::= "PUSH"

op2 ::= "JZ" | "JUMP"

label_name ::= <any of "a-z A-Z _"> { <any of "a-z A-Z 0-9 _"> }

comment ::= ";" <any symbols except "\n">

word_data ::= variable | string

variable ::= number | label_name

string ::= "\"" <any symbols except "\n"> "\""

number ::= 0x <any of "0-9 ABCDEF">
```

Поддерживаются однострочные комментарии, начинающиеся с ;

  - ```DUP``` - продублировать вершину стека данных ```[a] -> [a, a]```
  - ```OVER``` - дублировать второй элемент на стеке данных через первый ```[a, b] -> [b, a, b]```
  - ```POP``` - удалить значение с вершины стека данных ```[a] -> []```
  - ```SWAP``` - поменять местами два значения на вершине стека данных ```[a, b] -> [b, a]```
  - ```LOAD``` - загрузить из памяти значение по адресу с вершины стека ```[address] -> [value_from_memory]```
  - ```SAVE``` - взять адрес с вершины стека данных и записать в память значение, следующее после вершины стека данных ```[value, address] -> []```
  - ```INC``` - увеличить значения на вершине стека данных на 1 ```[a] -> [a + 1]```
  - ```DEC``` - уменьшить значения на вершине стека данных на 1 ```[a] -> [a - 1]```
  - ```ADD``` - сумма двух значений на вершине стека данных ```[a, b] -> [b + a]```
  - ```SUB``` - разность двух значений на вершине стека данных (первое вычитается из второго) ```[a, b] -> [a - b]```
  - ```DIV``` - целочисленное деление двух значений на вершине стека данных (второе делится на первое) ```[a, b] -> [a // b]```
  - ```MUL``` - произведение двух значений на вершине стека данных ```[a, b] -> [b * a]```
  - ```PUSH number``` - положить число на стек ```[] -> [2]```
  - ```PUSH label``` - положить адрес метки на стек ```[] -> [0x801]```
  - ```JZ label``` - переход на метку при условии, что флаг zero (Z) равен 1 
  - ```JUMP label``` - безусловный переход на метку

### Семантика
  - Язык предполагает последовательное исполнение
  - Глобальная область видимости меток
  - В программе не может быть дублирующихся меток, определенных в разных местах с одним именем. 
  - В программе должна быть определена метка ```_start``` указывающая на адрес первой исполняемой команды
  - Метки для переходов определяются на отдельных строчках:
    ``` asm
    label: 
        INC
    ```
    И в другом месте (неважно, до или после определения) сослаться на эту метку:
    ``` asm 
    jmp label   ; --> `jmp 123`, где 123 - номер инструкции после объявления метки
    ```

## Модель процессора

### DataPath
```
        +-----------+                                                    
        |           +----push                                            
        |   data    |                            +----------+            
        |   stack   +----pop   sel               |          |            
        |           |           |                |  Memory  |            
        |           |         +-v-+              |          |<-- read    
        +-----------+         | M |              |          |            
        |           |         | U |<---------+---+          |<-- wrire   
        |    TOS  | |<--------+ X |          |   |          |            
        |         | |         |   |<---+     |   +----------+            
    (0) ++--------+-+         +---+    |     |   |   IO     |            
      |  |        |  |(0)              |     |   |          |            
      v  v        v  v                 |     |   +----------+            
     +----+      +----+                |     |          ^                
top->|MUX |      |MUX |<--second       |     |          |                
     +--+-+      +-+--+                |     |          +------+         
        |          |                   |     |          |      |         
        v          v                   |     |    +-----+----+ |         
      -------    ------                |     |    |    AR    |<+-latch_ar
      \      \  /      /               |     |    +----^-----+ |         
       \      \/      /z_flag          |     |         |       +1        
~-+/*^->\    ALU     /-----------+     |     |      +--+--+    |         
 +1 -1   \          /            |     |     |      | MUX |    |         
          --+-------             |     |     |      +-----+    |         
            |                    |     |     |        ^ ^      |         
            +--------------------+-----+-----+--------+ +------+         
                                 |           |                           
                           +-----v-------+   |                           
                           |             |   |                           
                           |   Control   |<--+                           
                           |    Unit     |                               
                           |             |                               
                           +-------------+                               
```

### Control Unit
```
                            +---------------+
                            |               |
                 +--------->|    Step       |
                 |          |    Counter    |
                 |          |               |
                 |          +--------+------+
                 |                   |       
          +------+-------+           |       
          |              |           |       
          |  Instruction |           |       
   +------+  Decoder     |<----------+       
   |      |              |                   
   |      |              |                   
   |      +---+----------+                   
   |          |      ^                       
   |          |      |                       
instr     signals    |z_flag                 
   |          |      |                       
   |          v      |                       
   |      +----------+---+                   
   |      |   Data       |                   
   +----->|   Path       |                   
          |              |                   
          +--------------+                   
```
